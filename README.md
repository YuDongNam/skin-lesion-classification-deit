# 피부 병변 분류(7-class) 연구 보고서

본 문서는 학부 연구 프로젝트로 수행된 피부 병변 이미지 분류 과제의 연구 맥락, 방법, 실험 설정, 결과 및 분석을 학술적 서술 방식으로 정리한 자료이다. 프로젝트의 1차적 목표는 성능 지표의 절대적 극대화가 아니라, 문제 정의에서부터 데이터 구성, 모델링 선택, 한계 분석과 교훈 도출에 이르는 전 과정을 체계적으로 기록하는 데 있다.

## 1. 연구 배경 및 목적
- 피부암의 조기 진단은 임상적으로 중요한 과제이며, 피부 병변(dermatoscopic) 이미지의 자동 분류는 이를 보조할 잠재력이 있다.
- 본 연구는 공개 데이터셋(HAM10000, ISIC 2019)을 활용해 7개 클래스(nv, mel, bkl, bcc, akiec, vasc, df)에 대한 다중 분류기를 구축하고, 전이학습 기반의 합리적 실험 설계를 통해 모델 성능과 한계를 분석한다.
- 최종 목표는 다음의 연구 질문을 다루는 것이다.
  1) 데이터 구성(해상도, 클래스 불균형)에 따른 성능 특성은 무엇인가?
  2) 전이학습(backbone) 선택(VGG19, EfficientNetV2S, DeiT)에 따른 성능 차이는 어떠한가?
  3) 전처리(예: 모폴로지 기반 털 제거)가 실제 성능에 미치는 영향은 무엇인가?

## 2. 데이터셋
- HAM10000
  - 10,015장의 dermatoscopic 이미지와 메타데이터(csv)로 구성.
  - 클래스: nv, mel, bkl, bcc, akiec, vasc, df (심한 클래스 불균형 존재).
- ISIC 2019
  - 학습/평가에 활용 가능한 추가 이미지 및 정답 정보 제공.
- 본 연구에서는 7개 클래스 체계를 유지하였으며, 레이블 매핑은 다음과 같다.
  - nv: 0, mel: 1, bkl: 2, bcc: 3, akiec: 4, vasc: 5, df: 6

## 3. 방법론
### 3.1 전처리 및 입력 해상도
- 입력 해상도: 224×224 및 384×384 비교.
- 정규화 및 크기 변환(resizing) 적용.
- 모폴로지 기반 털 제거(blackhat + threshold + inpainting)를 구현하였으나, 실험 결과에 따라 사용 여부를 선택적으로 적용.

### 3.2 모델
- 비교 기준: VGG19, EfficientNetV2S(Keras/TensorFlow), DeiT(Hugging Face Transformers, PyTorch).
- 최종 베이스라인: DeiT-base-patch16-384.

### 3.3 학습 전략
- 2단계 학습 절차
  - 선형 탐색(linear probing): 분류기 헤드만 학습.
  - 전체 미세 조정(full fine-tuning): 백본을 포함한 전체 파라미터 미세 조정.
- 공통 설정(대표)
  - 배치 크기: 32
  - 최적화: AdamW(Transformers 기본 설정), 혼합정밀도(fp16) 활용
  - 조기 종료(Early Stopping) 및 체크포인트 저장

구체적 실행 스크립트와 인자는 `src/train.py`, `src/evaluate.py`에 포함되어 있으며, 커맨드라인 인자로 조절 가능하다.

## 4. 구현 개요(코드 구조)
```
skin-lesion-classification/
├── data/                    # 데이터 문서화 및 메타데이터(csv)
├── src/
│   ├── data_preprocessing.py  # 데이터 로드, 전처리(털 제거 포함), 분할
│   ├── train.py               # DeiT 중심 학습 파이프라인(전이학습 + 미세조정)
│   ├── evaluate.py            # 혼동행렬, ROC/PR 곡선 등 평가 및 시각화
│   └── utils.py               # 공통 유틸리티(로그, 지표 계산, 시각화)
├── notebooks/               # 원본 노트북(버전관리 제외됨)
├── models/                  # 체크포인트(버전관리 제외 권장)
├── results/                 # 결과 산출물(버전관리 제외 권장)
├── requirements.txt         # 의존성 명세
└── README.md                # 본 문서
```

## 5. 실험 설정
- 데이터 분할: 공개 메타데이터를 기반으로 학습/평가 분리(세부는 노트 참고).
- 증강: 회전, 평행이동, 줌, 수평 뒤집기 등 표준적 이미지 증강(필요 시 적용).
- 해상도 비교: 224 대비 384 입력에서 DeiT 성능이 일관되게 우수.
- 로깅: 필요 시 W&B 사용(선택), TensorBoard 대체 가능.

## 6. 결과 요약
- 최고 성능: balanced accuracy 45%(7-class), DeiT-base-patch16-384 사용 시 관측.
- 주요 관찰
  - Melanoma(악성) 탐지에서 재현율(Recall)은 상대적으로 양호하나, Nevus와의 오분류로 인해 정밀도(Precision)은 낮아 다수의 false positive가 발생.
  - 클래스 불균형의 영향이 뚜렷하며, 소수 클래스(vasc, df 등)에서 성능 저하가 큼.
  - 해상도 384가 224 대비 분류 성능에 긍정적 영향을 보임.

### 털 제거 전처리에 대한 분석
- 초기 가설: 이미지 상의 머리카락/체모 제거가 병변 패턴을 명확히 하여 성능 향상에 기여할 것.
- **관찰 결과:** **Gaussian blur와 Blackhat과 같은 알고리즘은 병변의 미세 패턴까지 제거하는 부작용을 초래하여, 전체 성능을 저해하는 결과를 가져왔다고 판단됨.**
- 결론: 이미지 내 나타나는 병변의 크기, 털의 길이, 선형 여부등을 따져 정밀한 케이스 분류를 통해 알고리즘을 적절히 구분하여 적용해야함.

## 7. 논의
- 임상적 고려: 악성 탐지에서 높은 재현율은 스크리닝 관점에서 바람직하나, 정밀도 저하는 추가적 임상 판독/후속 검사 비용을 유발할 수 있음.
- 데이터 불균형: 단순 가중치 조정이나 기본 증강만으로는 소수 클래스 성능 개선에 한계가 존재.
- 모델 선택: CNN(VGG/EfficientNet) 대비 Vision Transformer(DeiT)가 본 데이터셋에서 상대적으로 유리했으며, 해상도 증가에 따른 이점이 확인됨.

## 8. 한계 및 향후 과제
- 한계
  - 절대 성능이 제한적이며, 특히 소수 클래스에서의 성능 저하가 뚜렷함.
  - 데이터셋 편향 및 도메인 차이(기관/기기/촬영조건)에 대한 일반화 평가가 부족함.
- 향후 과제
  - 클래스 불균형 대응: 재표본화, 비용 민감 학습, Focal Loss 등 대안 검토.
  - 어텐션 시각화: 모델의 판단 근거 해석(Grad-CAM/Attention Rollout 등).
  - 다해상도/다중스케일 학습: 병변의 국소/전역 정보를 동시에 활용.
  - 준지도/자기지도 학습: 라벨 의존도를 낮추는 사전학습 전략 모색.
  - 메타데이터 융합: 환자 연령/부위 등 비전 특성의 멀티모달 결합.
  - 앙상블 고려: ISIC 챌린지 리더보드 기준 다양한 상위권 유저들은 앙상블을 이용하여 성능 향상을 꾀했음. 이를 고려하여 추후 연구에 반영을 검토.

## 9. 재현을 위한 실행 방법
### 9.1 환경 준비
```
python -m venv venv
# Windows: venv\Scripts\activate
# macOS/Linux: source venv/bin/activate
pip install -r requirements.txt
```

### 9.2 데이터 배치
- `data/` 하위에 메타데이터(csv)와 이미지 폴더를 배치한다. 구체적 경로 규칙은 코드 참고.

### 9.3 학습 실행 예시
```
python src/train.py \
  --data_dir data/ \
  --output_dir models/ \
  --model_name facebook/deit-base-patch16-384 \
  --image_size 384 \
  --batch_size 32 \
  --transfer_epochs 10 \
  --finetune_epochs 20
```

### 9.4 평가 실행 예시
```
python src/evaluate.py \
  --model_path models/final_model/ \
  --data_dir data/ \
  --output_dir results/
```

## 10. 결론
- 본 연구는 공개 데이터셋 기반의 7-class 피부 병변 분류 문제에서 전이학습과 미세 조정을 결합한 DeiT 기반 접근을 비교·분석하였다.
- 절대 성능은 제한적이지만, 데이터/해상도/전처리 선택이 성능에 미치는 영향을 체계적으로 관찰했으며, 특히 공격적 전처리가 오히려 성능을 저해할 수 있음을 정량적으로 확인하였다.
- 본 결과는 임상 환경에서의 적용 가능성을 높이기 위한 후속 연구(불균형 완화, 해석 가능성 강화, 멀티모달 융합 등)의 필요성을 시사한다.
